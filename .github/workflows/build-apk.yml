name: Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    container: kivy/kivy:latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure git
      run: |
        git config --global user.email "build@example.com"
        git config --global user.name "Builder"
        git config --global safe.directory '*'
    
    - name: Build APK
      run: |
        cd ${{ github.workspace }}
        
        # Show environment
        echo "Python: $(python --version)"
        echo "Java: $(java -version 2>&1 | head -1)"
        
        # Install requirements
        pip install kivy==2.1.0
        
        # Run buildozer
        echo "=== Starting buildozer build ==="
        buildozer android debug 2>&1 | tail -100
        
        # Check for APK
        echo ""
        echo "=== Checking for generated APK ==="
        if [ -d "bin" ]; then
          ls -lah bin/
          find bin -name "*.apk" -exec ls -lh {} \;
        else
          echo "No bin directory found"
        fi
      timeout-minutes: 120
      continue-on-error: true
    
    - name: Upload APK
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-debug
        path: |
          bin/*.apk
          bin/**/*.apk
        if-no-files-found: ignore
